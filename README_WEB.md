# 能源看板 Web 系統

## 系統架構

```
電表 ↔ LabVIEW (port 8888) ↔ Web伺服器 (port 5177) ↔ 瀏覽器
```

## 檔案說明

### 主要檔案
- `web_server.py` - 新的 Web 伺服器主程式
- `energy_dashboard.html` - 能源看板網頁 (已更新)
- `final.json` - 資料交換檔案
- `tcp_server.py` - 原 TCP 伺服器 (已不使用)

## 系統功能

### Web 伺服器 (port 5177)
1. **HTTP 伺服器** - 提供網頁服務
2. **TCP 客戶端** - 每 5 秒向 LabVIEW 請求電表資料
3. **自動開啟網頁** - 啟動後自動開啟 `energy_dashboard.html`
4. **資料更新** - 將接收到的資料寫入 `final.json`

### 網頁功能
1. **即時顯示** - 顯示電表的各項數據
2. **自動重新整理** - 每 5 秒重新載入資料
3. **視覺化圖表** - 圓餅圖、趨勢圖等
4. **響應式設計** - 適應不同螢幕尺寸

## 使用方法

### 啟動步驟
1. **確保 LabVIEW 在 port 8888 運行**
2. **執行 Web 伺服器**：
   ```bash
   python web_server.py
   ```
3. **系統會自動**：
   - 啟動 Web 伺服器在 port 5177
   - 開始每 5 秒查詢電表資料
   - 開啟瀏覽器顯示能源看板

### 手動訪問
如果網頁沒有自動開啟，可手動訪問：
```
http://localhost:5177/energy_dashboard.html
```

## 通訊協議

### 與 LabVIEW 的通訊
按照 `localhost.md` 規格：
- **命令格式**: `000007query36`
- **回應格式**: `000407[JSON資料]96`
- **更新頻率**: 每 5 秒一次

### 資料流程
1. Web 伺服器向 LabVIEW 發送 `query` 命令
2. LabVIEW 查詢電表並回傳 JSON 資料
3. Web 伺服器將資料寫入 `final.json`
4. 網頁每 5 秒讀取 `final.json` 更新顯示

## 錯誤處理

### 連線失敗
- **LabVIEW 未啟動**: 顯示連線錯誤訊息
- **電表無回應**: 繼續使用上次的資料
- **網路問題**: 自動重試連線

### 資料異常
- **JSON 格式錯誤**: 跳過本次更新
- **CheckSum 錯誤**: 重新請求資料
- **檔案讀寫錯誤**: 顯示錯誤訊息

## 優勢特點

### 1. **架構清晰**
- LabVIEW 專責電表通訊
- Web 伺服器負責網頁服務
- 職責分離，易於維護

### 2. **即時性**
- 5 秒更新週期
- 自動重新整理
- 無需手動刷新

### 3. **穩定性**
- 錯誤重試機制
- 超時保護
- 優雅的系統關閉

### 4. **使用便利**
- 一鍵啟動
- 自動開啟網頁
- 跨平台支援

## 注意事項

1. **確保 LabVIEW 先啟動** - Web 伺服器需要連接到 port 8888
2. **防火牆設定** - 確保 port 5177 和 8888 未被阻擋
3. **資源使用** - 每 5 秒的查詢會產生一定的系統負載
4. **瀏覽器相容性** - 建議使用現代瀏覽器 (Chrome, Firefox, Edge)

## 停止系統

按 `Ctrl+C` 可優雅地停止整個系統，包括：
- 停止 TCP 查詢
- 關閉 Web 伺服器
- 清理系統資源 